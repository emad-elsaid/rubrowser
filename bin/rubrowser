#!/usr/bin/env ruby
$LOAD_PATH.push File.expand_path('../lib', __dir__)

require 'optparse'
require 'rubrowser'
require 'rubrowser/renderer'

options = {
  toolbox: true,
  layout: nil,
  output: $stdout
}

OptionParser.new do |opts|
  opts.banner = "Usage: #{File.basename(__FILE__)} [options] [file] ..."

  opts.on(
    '-oFILE',
    '--output=FILE',
    'output file page, if not specified output will be written to stdout'
  ) { |output| options[:output] = output }

  opts.on(
    '-lFILE',
    '--layout=FILE',
    'layout file to apply on the resulting graph'
  ) { |layout| options[:layout] = layout }

  opts.on(
    '-sSERVER:PORT',
    '--server=SERVER:PORT',
    'rubrowser server for execution monitoring'
  ) { |server| options[:server] = server }

  opts.on('-T', '--no-toolbox', 'Don\'t display toolbox on the page') do
    options[:toolbox] = false
  end

  opts.on('-j', '--json', 'Do export data as JSON instead of HTML') do
    options[:json] = true
  end

  opts.on('-v', '--version', 'Print Rubrowser version') do
    puts "Rubrowser #{Rubrowser::VERSION}"
    exit
  end

  opts.on('-h', '--help', 'Prints this help') do
    puts opts
    exit
  end
end.parse!

options[:files] = ARGV.empty? ? ['.'] : ARGV

Rubrowser::Renderer.call(options)
